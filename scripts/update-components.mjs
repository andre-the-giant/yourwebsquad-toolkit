#!/usr/bin/env node
import fs from "fs/promises";
import path from "path";
import process from "process";
import { execa } from "execa";
import inquirer from "inquirer";
import chalk from "chalk";
import semver from "semver";

const repoRoot = process.cwd();
const pkgPath = path.join(repoRoot, "package.json");
const dependencyName = "yourwebsquad-components";
const dependencyRepo = "https://github.com/andre-the-giant/yourwebsquad-components.git";

const starLine = chalk.gray("★".repeat(50));
const infoArt = chalk.white(
  [
    "Check these titties while you wait",
    "▒░▒░▒░▓▓▓▓▓▓▓▓▓▓▓▒▒▒▓░▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█▓▓█░▓████████████████████████████████████████████████████████",
    "▒░▒░▒░▓▓▓▓▓▓▓▓▓▓▓▒▒▒▓░▓▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█████▓█▓▒▓█████████████████████████████████████████████████████",
    "▒░▒░▒▒▒█▓▓▓▓▓▓▓▓▒▒▒▒▒▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓▓▓▓▓▓▓▒▓▓▓▓▓▓▓▓▓████████████▒▒▓█████████████████████████████████████████████████",
    "░░▒░▒▒░▒▓▓▓▓▓▓▓▓▓▒▒▒▒▒▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓█▓▓▓▓▓▓▓▒▓▓▓▓▓▓▓█████████████████▓▒▒▒▓██████████████████████████████████████████",
    "░░▒░▒▒░░▓▓▓▓▓▓▓▓▓▓▓▓▒▒▒▓▓▓▓▓▓▓▓▓▓▓████████████▓▓▓▓▒▓▓▓▓▓▓▓██████████████████████▓▒▒▓████████████████████████████████████",
    "░░▒▒░▒▒░▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒▓▓▓▓▓▓▓▓▓▓▓███▓████████████▓█▓▓█▓▓█▓███████████████████████████▒▒████████████████████████████████",
    "░░▒▒░▒▒▒░▓▓▓▓▓▓▓▓▓▓▓▓▓▒▓▓▓▓▓▓▓▓▓▓▓████████████████████▓▒██▓▓██████████████████████████████▒▓████████████████████████████",
    "▒░▓░▒▒▒▒░▒▓▓▓▓▓▓▓▓▓▓▓▓▒▓▓▓▓▓▓▓▓▓▓▓████████████████████▓██▓▒██▓█▓███████████████████████████▓█▒██████████████████████████",
    "▓░░▒█▒▒▒░░▒▓▓▓▓▓▓▓▓▓▓▓▒▓▓▓▓▓▓▓▓▓▓▓█████████████▓▓▓▓▓████▓███▒▓▓█▓█▓████████████████████████████▓▓▓▓▓▓███████████████████",
    "███▒ ▓▓▒▒░ █▓▓▓▓▓▓▓▓▓▓▒▒▓▓▓▓▓▓▓▓▓███████████▓▓▓▓▓▓▓▓▓▓▓████▓▓█▒▓██▓█▓███████████████████████████▓▓▓▓▓▓▓▒▒▒▒█████████████",
    "████████▒░░░▓▓▓▓▓▓▓▓▓▓▒▓▓▓▓▓▓▓▓▓▓▓████████▓▓▓▓▓▓▓▓▒▒▒▓▓▓█████▓▓█▓▓▓██▓▓███████████████████████████▓▓▓▓▓▓▓▓▒▒▓███████████",
    "████████▒░░▒▓█▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓████████▓▓▓▓▓▓▓▓▒▓▒▒▓▓▓▓████▓▓▓█▒▓▓▓▓▓████▓▓██████████████████████▓▓▓▓▓▓▒█████████████",
    "████████▒▒░▒▓▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███████▓▓▓▓▓▓▓▓▓▓▒▒▓▒▓▓▓▓███▓▓▓▓█░▓▓▓▓▓▓▓▓███████████████████████▓▓▓▓▓▓▓▒█████████████",
    "████████▓░░███▓▓▓▓▓▓▓▓▓▒▓▓▓▓▓▓▓▓▓▓▓█████████▓▓▓▓▓▓▓▓▒▒▒▓▓▓▓█▓█▓▓▓▓▓▓▒▓▓▓▓▓▓▓▓▓▓▓███████████████████▓▓▓▓▓▓▓▒█████████████",
    "██████▓█▓░████▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓████████████▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓█▒▓▓▓▓▓▓▓▓▓▓▓▓▓██████████████▓▓▓▓▓▓▓▓▓▒█████████████",
    "█████▓▒▒▓██████▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓██████████▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓░▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█████████████",
    "████████████████▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓██████████▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓▓▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒█████████████",
    "████████████████▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█████████▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓▓▓░▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓██████████████",
    "█████████████████▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███████▓▓▓▓▓▓▓▓▓▓▓▓██▓▓▓▓▓▓▓▓▓▓▓░▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓██████████████",
    "██████████████████▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓██████▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓██████████████",
    "███████████████████▓▓▓▓▓▓▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓██████████████",
    "████████████████████▓▓▓▓▓▒▒▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓░▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒██████████████",
    "█████████████████████▓▒▓▓▓▒▒▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓░▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒███████████████",
    "███████████████████████░▓▓▓░▓▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓░▓▓▒▒▒▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███████████████",
    "████████████████████████░▓▒▓░▒▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓░▒▒▒▓▓░▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒████████████████",
    "█████████████████████████▒░▓▓▒▓▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓░▓▓▓▒▓▓▓▓░▓▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█████████████████",
    "████████████████████████████▒▓░▓▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒▒▒▓▓▓▓▓▓▓▓▓▓▓░▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒▓▓███████████████████",
    "█████████████████████████████▒▒▒░▒▒▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒▒▓▓▓▓▓▓▓▓▓▓▓▓▓ ▒▓▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▓▓████████████████████",
    "███████████████████████████████▒▒▒▒▓▒▒▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒▒▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒░▒▓▒▒▒▒▒▒▒▒▓▓▓███████████████████████",
    "█████████████████████████████████▒▓▓░▒▓▒▒▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒████▓▓▒▒▓▓▓███████████████████████████",
    "██████████████████████████████████▓▒▒▓▓▒░▒▒▓▓▓▓▓▓▓▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒█████████████████████████████████████",
    "████████████████████████████████████▒▓▓▒▒▒▓▓▓▓▓▒▒▒▒▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒▒████████████████████████████████████",
    "██████████████████████████████████████▒▒▒▒▒▓▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒████████████████████████████████████",
    "███████████████████████████████████████▓▓▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒▓▓▓▓▓▓▓▓▓▓███████████████████████████████████",
    "████████████████████████████████████████▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒▓▓▓▓▓▓▓▓▓▓███████████████████████████████████"
  ].join("\n")
);

const successArt = chalk.green(
  [
    "                                                                                ",
    "█████████████████████████████▓              ███████████████████████████████████",
    "███████████████████████████                   █████████████████████████████████",
    "████████████████████████                       ▒███████████████████████████████",
    "██████████████████████                           ▒█████████████████████████████",
    "█████████████████████                              ████████████████████████████",
    "████████████████████                                ███████████████████████████",
    "████████████████████        ██████ ███████▓          ██████████████████████████",
    "████████████████████       █████████████████        ▒██████████████████████████",
    "█████████████████████      █████████████████▓       ███████████████████████████",
    "██████████████████████     ██████████████████      ████████████████████████████",
    "██████████████████████▓    ██████████████████     █████████████████████████████",
    "███████████████████████▓   █   ░█████████▓        █████████████████████████████",
    "███████████████████████░█  ███     ███      ███  █ ████████████████████████████",
    "███████████████████████▒██ ██▓ ░░ ████ █ ▓░ ███░███████████████████████████████",
    "████████████████████████ ██████ ░█████░█ ████████ █████████████████████████████",
    "████████████████████████▒█████████████░ █████████▒█████████████████████████████      Great success !",
    "█████████████████████████ ████████▓████ ░█████ █ ██████████████████████████████",
    "███████████████████████████░████▒   ██      ██ ████████████████████████████████",
    "███████████████████████████ ██               █▓████████████████████████████████",
    "█████████████████████████████░██  █▒   ▒█      ████████████████████████████████",
    "████████████████████████████ █ ███ █████ ▒▓█ █░████████████████████████████████",
    "█████████████████████████████ ███████▒▒░ ████ ▒████████████████████████████████",
    "█████████████████████████████  ███████████▓   █████████████████████████████████",
    "██████▓██ ███████████████████ █▒█ ███████   ▓▓ ▓█████████████████████████ █████",
    "█████████▓██████████████████   ███▓  ▒      █    ▒███████████████████ ███ █████",
    "██████ ███ ███████████████       ░████▓█████      █ ████████████████▒███▓██████",
    "██████████▒████████████░ ██         ▓████          █  ██████████████ ███░██████",
    "████    ███ █████████ █████                        █░███ ░█████████ ███    ░███",
    "███████████ ▓███▓ ░█████████       ░████           ███████░█░ ▒████░███████████",
    "█ ███ █▒ ██  ▓██████████████         ███          ░████████ ██████ ██▒ ███▓████",
    "█ █████████  ████████████████        ░█           ██░███████ ████████████████  ",
    "█████░░ ▓██  █████▒██████████         █           ██ ████████░████ ▒ █  ███████",
    "▓█████████ █ ██████ █████████▓       ▓██          ██ ██████▓ ███████ █████████ ",
    "██████░░█ ██████████ ████████       ███▒        ▒████████ ████████ ██░▓███████",
    "▒██████  ██████████ █████████      █████        ██░███████ ████████ ████████▒ ",
    "█  ██   ░█░██████████████ █████     ██████       ██████████████████████   ▓█  █",
    "█      █▒  ███████▓██████▒█████     ██████▒      ████████████ ██████   ▓      █",
    "█      ██ ███ ████▓█████████████    ███████     █████████████ ███ ██▒ ██░     ▒"
  ].join("\n")
);

const errorArt = chalk.red(["  !!!   Oh no!", " (x x)", "  \\_/ "].join("\n"));

function logInfo(msg) {
  console.log(`${starLine}\n${infoArt}\n\n${chalk.cyan(msg)}\n${starLine}`);
}

function logSuccess(msg) {
  console.log(`${starLine}\n${successArt}\n\n${chalk.green(msg)}\n${starLine}`);
}

function logError(msg) {
  console.error(`${starLine}\n${errorArt}\n\n${chalk.red(msg)}\n${starLine}`);
}

async function readJson(filePath) {
  const raw = await fs.readFile(filePath, "utf8");
  return JSON.parse(raw);
}

async function writeJson(filePath, data) {
  const serialized = `${JSON.stringify(data, null, 2)}\n`;
  await fs.writeFile(filePath, serialized, "utf8");
}

async function getCurrentTag(pkg) {
  const dep = pkg.dependencies?.[dependencyName];
  if (!dep) {
    throw new Error(`Dependency ${dependencyName} not found in package.json.`);
  }
  const hashIndex = dep.lastIndexOf("#");
  if (hashIndex === -1 || hashIndex === dep.length - 1) {
    throw new Error(`Dependency ${dependencyName} does not include a tag (expected '#vX.Y.Z').`);
  }
  return dep.slice(hashIndex + 1);
}

async function fetchTags() {
  try {
    const { stdout } = await execa("git", ["ls-remote", "--tags", dependencyRepo]);
    const tags = stdout
      .split("\n")
      .map((line) => line.trim())
      .filter(Boolean)
      .map((line) => line.split(/\s+/)[1])
      .filter((ref) => ref && !ref.endsWith("^{}"))
      .map((ref) => ref.replace("refs/tags/", ""))
      .filter((tag) => semver.valid(semver.clean(tag)));

    const unique = Array.from(new Set(tags));
    unique.sort((a, b) => semver.rcompare(semver.clean(a), semver.clean(b)));
    return unique;
  } catch (err) {
    throw new Error(`Unable to fetch tags: ${err.shortMessage || err.message}`);
  }
}

function filterNewerTags(allTags, currentTag) {
  const currentClean = semver.clean(currentTag);
  if (!currentClean) return allTags;
  return allTags.filter((tag) => semver.gt(semver.clean(tag), currentClean));
}

async function selectTag(currentTag, allTags) {
  if (!allTags.length) {
    throw new Error("No tags available in remote repository.");
  }

  const { targetTag } = await inquirer.prompt([
    {
      type: "list",
      name: "targetTag",
      message: `Current ${dependencyName} tag is ${currentTag}. Choose target:`,
      choices: allTags.map((tag) => ({ name: tag, value: tag }))
    }
  ]);

  return targetTag;
}

async function updateDependency(pkg, newTag) {
  const dep = pkg.dependencies?.[dependencyName];
  if (!dep) {
    throw new Error(`Dependency ${dependencyName} not found in package.json.`);
  }
  const hashIndex = dep.lastIndexOf("#");
  const base = hashIndex === -1 ? dep : dep.slice(0, hashIndex);
  pkg.dependencies[dependencyName] = `${base}#${newTag}`;
  await writeJson(pkgPath, pkg);
}

async function main() {
  try {
    const pkg = await readJson(pkgPath);
    const currentTag = await getCurrentTag(pkg);

    logInfo("Fetching available tags...");
    const tags = await fetchTags();

    const newerTags = filterNewerTags(tags, currentTag);
    if (!newerTags.length) {
      logSuccess("You already have the latest available version, muthafucka !");
      return;
    }

    const targetTag = await selectTag(currentTag, newerTags);

    logInfo(`Updating ${dependencyName} to ${targetTag} in package.json...`);
    await updateDependency(pkg, targetTag);

    logInfo("Cleaning workspace (removing lockfile, build artifacts, node_modules)...");
    await execa("npm", ["run", "clean"], { stdio: "inherit" });

    logInfo("Reinstalling dependencies...");
    await execa("npm", ["install"], { stdio: "inherit" });

    logSuccess(`Updated ${dependencyName} to ${targetTag} successfully.`);
  } catch (err) {
    logError(err.message || String(err));
    process.exit(1);
  }
}

main();
