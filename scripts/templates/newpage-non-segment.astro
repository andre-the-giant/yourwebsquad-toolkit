---
import MainLayout from "@layouts/Main.astro";
import { createContentHelpers } from "@toolkit/content";
import { buildJsonLd, buildSeo } from "@toolkit/seo";
import { defaultLang, defaultSeoValues, hreflangMapDefault } from "../../../../seo.config.mjs";
const fallbackLocale = "__DEFAULT_LOCALE__";

export async function getStaticPaths() {
  const supportedLocales = __LOCALES__;
  return supportedLocales.map((locale) => ({
    params: { lang: locale }
  }));
}

const supportedLocales = __LOCALES__;
const { lang } = Astro.params;
const locale = supportedLocales.includes(lang) ? lang : fallbackLocale;
const normalizedSite = (import.meta.env.SITE_URL || "").replace(/\/+$/, "");
const helperConfig = {
  siteUrl: normalizedSite,
  hreflangMap: hreflangMapDefault,
  defaultLang,
  seoDefaults: defaultSeoValues
};
const { getContent, getCompany } = createContentHelpers();

const content = await getContent(locale, "__SLUG__");
const company = await getCompany("company");
const contact = await getCompany("contact");
const social = await getCompany("social");

const path = `/${locale}/__SLUG__/`;
const seo = buildSeo({
  locale,
  path,
  overrides: content.seo,
}, helperConfig);

const defaultLocation =
  (company.locations || []).find((loc) => loc.isDefault) ||
  company.locations?.[0];
const primaryPhone =
  contact.telephones?.find((t) => t.isPrimary)?.short ||
  contact.telephones?.[0]?.short ||
  "+33 2 31 00 00 00";
const sameAs = (social.links || []).map((link) => link.url).filter(Boolean);
const jsonLd = buildJsonLd({
  locale,
  path,
  org: {
    name: company.name,
    url: company.url,
    telephone: primaryPhone,
    streetAddress: defaultLocation?.address?.street || contact.address?.street,
    addressLocality: defaultLocation?.address?.city || contact.address?.city,
    postalCode:
      defaultLocation?.address?.postalCode || contact.address?.postalCode,
    addressCountry:
      defaultLocation?.address?.country || contact.address?.country,
    geo: {
      latitude: defaultLocation?.lat || company.lat,
      longitude: defaultLocation?.lng || company.lng,
    },
  },
  openingHours: contact.hours?.openingHours,
  sameAs,
  image: content.seo?.image || social.image?.url,
}, helperConfig);
const seoPayload = { ...seo, jsonLd };
---

<MainLayout seo={seoPayload}>
  <section class="content">
    <h1>{content.seo?.title}</h1>
  </section>
</MainLayout>
