---
import MainLayout from "@layouts/Main.astro";
import { createContentHelpers } from "@toolkit/content";
import { buildJsonLd, buildSeo } from "@toolkit/seo";
import { createSegmentHelpers } from "@toolkit/segments";
import { defaultLang, defaultSeoValues, hreflangMapDefault } from "../../../../seo.config.mjs";
import { segments } from "../../../../segments.config.mjs";

const { getSegment, assertSegmentMatch, pathFor, alternatesFor } = createSegmentHelpers({
  segments
});
const { getContent, getCompany } = createContentHelpers();
const normalizedSite = (import.meta.env.SITE_URL || "").replace(/\/+$/, "");
const helperConfig = {
  siteUrl: normalizedSite,
  hreflangMap: hreflangMapDefault,
  defaultLang,
  seoDefaults: defaultSeoValues
};

export async function getStaticPaths() {
  const locales = ["fr", "en"];
  return locales.map((locale) => ({
    params: {
      lang: locale,
      __SEGMENT_KEY__Segment: getSegment(locale, "__SEGMENT_KEY__"),
    },
  }));
}

const { lang, __SEGMENT_KEY__Segment } = Astro.params;
const locale = lang === "en" ? "en" : "fr";
assertSegmentMatch(locale, "__SEGMENT_KEY__", __SEGMENT_KEY__Segment);

const content = await getContent(locale, "__SLUG__");
const company = await getCompany("company");
const contact = await getCompany("contact");
const social = await getCompany("social");

const path = pathFor(locale, "__SEGMENT_KEY__");
const alternates = alternatesFor("__SEGMENT_KEY__");
const seo = buildSeo({
  locale,
  path,
  alternates,
  overrides: content.seo,
}, helperConfig);

const defaultLocation =
  (company.locations || []).find((loc) => loc.isDefault) ||
  company.locations?.[0];
const primaryPhone =
  contact.telephones?.find((t) => t.isPrimary)?.short ||
  contact.telephones?.[0]?.short ||
  "+33 2 31 00 00 00";
const sameAs = (social.links || []).map((link) => link.url).filter(Boolean);
const jsonLd = buildJsonLd({
  locale,
  path,
  org: {
    name: company.name,
    url: company.url,
    telephone: primaryPhone,
    streetAddress: defaultLocation?.address?.street || contact.address?.street,
    addressLocality: defaultLocation?.address?.city || contact.address?.city,
    postalCode:
      defaultLocation?.address?.postalCode || contact.address?.postalCode,
    addressCountry:
      defaultLocation?.address?.country || contact.address?.country,
    geo: {
      latitude: defaultLocation?.lat || company.lat,
      longitude: defaultLocation?.lng || company.lng,
    },
  },
  openingHours: contact.hours?.openingHours,
  sameAs,
  image: content.seo?.image || social.image?.url,
}, helperConfig);
const seoPayload = { ...seo, jsonLd };
---

<MainLayout seo={seoPayload}>
  <section class="content">
    <h1>{content.seo?.title}</h1>
  </section>
</MainLayout>
